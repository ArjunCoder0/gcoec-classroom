<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam in Progress - GCOEC Portal</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            "500":"#3b82f6",
                            "600":"#2563eb",
                            "700":"#1d4ed8",
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'heading': ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        body { overflow: hidden; }
        
        .option-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .option-card:hover {
            transform: translateX(4px);
            border-color: #3b82f6;
        }
        
        .option-card.selected {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #3b82f6;
            border-width: 2px;
        }
        
        .question-btn {
            transition: all 0.2s ease;
        }
        
        .question-btn:hover {
            transform: scale(1.05);
        }
        
        .question-btn.answered {
            background: #10b981;
            color: white;
        }
        
        .question-btn.current {
            background: #3b82f6;
            color: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .timer-warning {
            animation: pulse-warning 1s infinite;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 py-3">
            <div class="flex justify-between items-center">
                <div class="flex-1 min-w-0">
                    <h1 class="text-lg sm:text-xl font-heading font-bold text-gray-800 truncate" id="examTitle">Loading...</h1>
                    <p class="text-xs sm:text-sm text-gray-600" id="examSubject"></p>
                </div>
                
                <div class="flex items-center gap-3 sm:gap-4">
                    <!-- Timer -->
                    <div id="timer" class="px-4 py-2 bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-lg shadow-md">
                        <div class="flex items-center gap-2">
                            <i data-lucide="clock" class="w-4 h-4"></i>
                            <span class="font-mono font-bold text-sm sm:text-base" id="timerValue">00:00:00</span>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <button onclick="submitExam()" 
                            class="px-4 sm:px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition flex items-center gap-2 shadow-md">
                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Submit</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex h-screen pt-16">
        <!-- Question Panel -->
        <div class="flex-1 overflow-y-auto p-4 sm:p-6">
            <div class="max-w-4xl mx-auto">
                <!-- Question Card -->
                <div id="questionCard" class="bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-6">
                    <!-- Question will be loaded here -->
                </div>
                
                <!-- Navigation -->
                <div class="flex gap-3">
                    <button id="prevBtn" onclick="previousQuestion()" 
                            class="flex-1 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-lg transition flex items-center justify-center gap-2">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        Previous
                    </button>
                    <button id="nextBtn" onclick="nextQuestion()" 
                            class="flex-1 px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-lg transition flex items-center justify-center gap-2">
                        Next
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="w-80 bg-white border-l border-gray-200 overflow-y-auto p-4 sm:p-6 hidden lg:block">
            <!-- Question Palette -->
            <div class="mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i data-lucide="grid-3x3" class="w-5 h-5"></i>
                    Question Palette
                </h3>
                <div id="questionGrid" class="grid grid-cols-5 gap-2">
                    <!-- Question buttons will be loaded here -->
                </div>
            </div>
            
            <!-- Legend -->
            <div class="border-t border-gray-200 pt-4">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Legend</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-green-500 rounded flex items-center justify-center text-white font-semibold">1</div>
                        <span class="text-gray-600">Answered</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gray-100 border-2 border-gray-300 rounded flex items-center justify-center text-gray-700 font-semibold">2</div>
                        <span class="text-gray-600">Not Answered</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-primary-600 rounded flex items-center justify-center text-white font-semibold shadow-lg">3</div>
                        <span class="text-gray-600">Current</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Warning Modal -->
    <div id="warningModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 sm:p-8">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-triangle" class="w-8 h-8 text-red-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Warning!</h3>
                <p id="warningMessage" class="text-gray-600 mb-6"></p>
                <button onclick="closeWarning()" 
                        class="w-full px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-lg transition">
                    I Understand
                </button>
            </div>
        </div>
    </div>

    <script src="student_auth.js"></script>
    <script>
        let examData = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let attemptId = null;
        let answers = {};
        let timerInterval = null;
        let remainingSeconds = 0;
        let tabSwitches = 0;
        let fullscreenExits = 0;

        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('exam_id');

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await verifyStudentAuth();
            startExam();
            setupAntiCheating();
            requestFullscreen();
        });

        async function startExam() {
            try {
                const API_BASE_URL = window.location.hostname === 'localhost' 
                    ? 'http://localhost:5000' 
                    : 'https://pyq-automation-system.onrender.com';
                
                const studentInfo = JSON.parse(localStorage.getItem('studentInfo') || '{}');
                
                const response = await fetch(`${API_BASE_URL}/api/student/exams/${examId}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('studentToken')}`
                    },
                    body: JSON.stringify({
                        email: studentInfo.email || 'student@example.com',
                        name: studentInfo.name || 'Student'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    examData = data.exam;
                    questions = data.questions;
                    attemptId = data.attempt_id;
                    
                    document.getElementById('examTitle').textContent = examData.title;
                    document.getElementById('examSubject').textContent = `${examData.subject} - Semester ${examData.semester}`;
                    
                    remainingSeconds = examData.duration_minutes * 60;
                    startTimer();
                    
                    renderQuestionGrid();
                    displayQuestion(0);
                    lucide.createIcons();
                } else {
                    alert('Error: ' + data.error);
                    window.location.href = 'student_exams.html';
                }
            } catch (error) {
                console.error('Error starting exam:', error);
                alert('Failed to start exam');
                window.location.href = 'student_exams.html';
            }
        }

        function startTimer() {
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                remainingSeconds--;
                updateTimerDisplay();
                
                if (remainingSeconds === 300) {
                    document.getElementById('timer').classList.add('timer-warning', 'bg-gradient-to-r', 'from-red-500', 'to-red-600');
                    showWarning('Only 5 minutes remaining!');
                }
                
                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    alert('Time is up! Submitting your exam...');
                    submitExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(remainingSeconds / 3600);
            const minutes = Math.floor((remainingSeconds % 3600) / 60);
            const seconds = remainingSeconds % 60;
            
            const display = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('timerValue').textContent = display;
        }

        function renderQuestionGrid() {
            const grid = document.getElementById('questionGrid');
            grid.innerHTML = questions.map((q, index) => `
                <button class="question-btn w-10 h-10 rounded font-semibold text-sm border-2 border-gray-300 bg-gray-50 hover:bg-gray-100 ${index === 0 ? 'current' : ''}" 
                        onclick="jumpToQuestion(${index})"
                        id="qBtn${index}">
                    ${index + 1}
                </button>
            `).join('');
        }

        function displayQuestion(index) {
            currentQuestionIndex = index;
            const question = questions[index];
            
            const card = document.getElementById('questionCard');
            card.innerHTML = `
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
                    <div class="flex items-center gap-3">
                        <span class="px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-sm font-semibold">
                            Question ${index + 1} of ${questions.length}
                        </span>
                    </div>
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold flex items-center gap-1">
                        <i data-lucide="award" class="w-4 h-4"></i>
                        ${question.marks} Mark${question.marks > 1 ? 's' : ''}
                    </span>
                </div>
                
                <div class="text-lg text-gray-800 mb-6 leading-relaxed">${question.question_text}</div>
                
                ${question.question_image ? `<div class="mb-6 text-center">
                    <img src="${question.question_image}" class="max-w-full max-h-96 rounded-lg shadow-md mx-auto border-2 border-gray-200">
                </div>` : ''}
                
                <div class="space-y-3">
                    ${['A', 'B', 'C', 'D'].map(opt => `
                        <div class="option-card p-4 border-2 border-gray-200 rounded-lg ${answers[question.id] === opt ? 'selected' : ''}" 
                             onclick="selectOption('${question.id}', '${opt}')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${answers[question.id] === opt ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700'} flex items-center justify-center font-bold flex-shrink-0">
                                    ${opt}
                                </div>
                                <div class="flex-1 text-gray-700">${question['option_' + opt.toLowerCase()]}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === questions.length - 1;
            
            updateQuestionGrid();
            lucide.createIcons();
        }

        function selectOption(questionId, option) {
            answers[questionId] = option;
            
            const options = document.querySelectorAll('.option-card');
            options.forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            saveAnswer(questionId, option);
            updateQuestionGrid();
        }

        async function saveAnswer(questionId, selectedAnswer) {
            try {
                const API_BASE_URL = window.location.hostname === 'localhost' 
                    ? 'http://localhost:5000' 
                    : 'https://pyq-automation-system.onrender.com';
                
                await fetch(`${API_BASE_URL}/api/student/attempts/${attemptId}/answer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('studentToken')}`
                    },
                    body: JSON.stringify({
                        question_id: questionId,
                        selected_answer: selectedAnswer
                    })
                });
            } catch (error) {
                console.error('Error saving answer:', error);
            }
        }

        function updateQuestionGrid() {
            questions.forEach((q, index) => {
                const btn = document.getElementById(`qBtn${index}`);
                btn.className = 'question-btn w-10 h-10 rounded font-semibold text-sm border-2';
                
                if (index === currentQuestionIndex) {
                    btn.className += ' current';
                } else if (answers[q.id]) {
                    btn.className += ' answered';
                } else {
                    btn.className += ' border-gray-300 bg-gray-50 hover:bg-gray-100';
                }
            });
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                displayQuestion(currentQuestionIndex - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                displayQuestion(currentQuestionIndex + 1);
            }
        }

        function jumpToQuestion(index) {
            displayQuestion(index);
        }

        async function submitExam() {
            const answeredCount = Object.keys(answers).length;
            const unansweredCount = questions.length - answeredCount;
            
            if (unansweredCount > 0) {
                if (!confirm(`You have ${unansweredCount} unanswered question(s). Are you sure you want to submit?`)) {
                    return;
                }
            }
            
            if (!confirm('Are you sure you want to submit your exam? You cannot change your answers after submission.')) {
                return;
            }
            
            try {
                // Stop timer immediately
                clearInterval(timerInterval);
                
                // Disable submit button to prevent double submission
                const submitBtn = document.querySelector('button[onclick="submitExam()"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> <span class="hidden sm:inline">Submitting...</span>';
                    lucide.createIcons();
                }
                
                const API_BASE_URL = window.location.hostname === 'localhost' 
                    ? 'http://localhost:5000' 
                    : 'https://pyq-automation-system.onrender.com';
                
                // Add timeout to fetch request (60 seconds for Render cold start)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);
                
                const response = await fetch(`${API_BASE_URL}/api/student/attempts/${attemptId}/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('studentToken')}`
                    },
                    body: JSON.stringify({
                        tab_switches: tabSwitches,
                        fullscreen_exits: fullscreenExits
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.success) {
                    // Remove beforeunload warning
                    window.onbeforeunload = null;
                    
                    // Show success message
                    alert('Exam submitted successfully! Redirecting...');
                    
                    // Force redirect
                    window.location.replace('student_exams.html');
                } else {
                    alert('Error: ' + data.error);
                    // Re-enable submit button on error
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i> <span class="hidden sm:inline">Submit</span>';
                        lucide.createIcons();
                    }
                    // Restart timer on error
                    startTimer();
                }
            } catch (error) {
                console.error('Error submitting exam:', error);
                
                let errorMessage = 'Failed to submit exam. ';
                if (error.name === 'AbortError') {
                    errorMessage += 'Request timed out. The server might be starting up. Please try again in a moment.';
                } else {
                    errorMessage += 'Please try again.';
                }
                
                alert(errorMessage);
                
                // Re-enable submit button on error
                const submitBtn = document.querySelector('button[onclick="submitExam()"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i> <span class="hidden sm:inline">Submit</span>';
                    lucide.createIcons();
                }
                // Restart timer on error
                startTimer();
            }
        }

        function setupAntiCheating() {
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    tabSwitches++;
                    trackActivity('tab_switch');
                    showWarning('Tab switching detected! This activity is being monitored.');
                }
            });
            
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    fullscreenExits++;
                    trackActivity('fullscreen_exit');
                    showWarning('You exited fullscreen mode! Please return to fullscreen.');
                    requestFullscreen();
                }
            });
            
            document.addEventListener('contextmenu', (e) => e.preventDefault());
            document.addEventListener('copy', (e) => e.preventDefault());
        }

        function requestFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => {
                    console.log('Fullscreen not available or denied:', err);
                });
            }
        }

        async function trackActivity(type) {
            try {
                const API_BASE_URL = window.location.hostname === 'localhost' 
                    ? 'http://localhost:5000' 
                    : 'https://pyq-automation-system.onrender.com';
                
                await fetch(`${API_BASE_URL}/api/student/attempts/${attemptId}/track`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('studentToken')}`
                    },
                    body: JSON.stringify({ type })
                });
            } catch (error) {
                console.error('Error tracking activity:', error);
            }
        }

        function showWarning(message) {
            document.getElementById('warningMessage').textContent = message;
            document.getElementById('warningModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeWarning() {
            document.getElementById('warningModal').classList.add('hidden');
        }

        window.addEventListener('beforeunload', (e) => {
            // Only show warning if exam is still in progress
            if (attemptId && timerInterval) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
