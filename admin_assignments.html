<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment Management - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-600 to-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <a href="admin_classroom.html" class="text-sm opacity-90 hover:opacity-100">‚Üê Back to Classroom</a>
                    <h1 class="text-2xl font-bold mt-1" id="className">Assignment Management</h1>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Create Assignment Button -->
        <div class="mb-6">
            <button onclick="openCreateAssignmentModal()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                ‚ûï Create New Assignment
            </button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <p class="mt-4 text-gray-600">Loading assignments...</p>
        </div>

        <!-- Assignments List -->
        <div id="assignmentsList" class="hidden space-y-6">
            <!-- Assignments will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12 bg-white rounded-xl shadow-md">
            <div class="text-6xl mb-4">üìã</div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">No Assignments Yet</h3>
            <p class="text-gray-600 mb-4">Create your first assignment to get started</p>
            <button onclick="openCreateAssignmentModal()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                ‚ûï Create Assignment
            </button>
        </div>
    </main>

    <!-- Create Assignment Modal -->
    <div id="assignmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-xl max-w-3xl w-full my-8">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Create New Assignment</h3>
                    <button onclick="closeAssignmentModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>

                <form id="assignmentForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assignment Title *</label>
                        <input type="text" id="assignmentTitle" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            placeholder="e.g., Lab Assignment 1: Array Operations">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                        <textarea id="assignmentDescription" required rows="3"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            placeholder="Brief description of the assignment"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Instructions (Optional)</label>
                        <textarea id="assignmentInstructions" rows="4"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            placeholder="Detailed instructions for students"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Marks *</label>
                            <input type="number" id="assignmentMarks" required min="1"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="10">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Due Date *</label>
                            <input type="datetime-local" id="assignmentDueDate" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="allowLate" class="w-4 h-4 text-indigo-600">
                            <span class="text-sm text-gray-700">Allow late submissions</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="allowMultiple" class="w-4 h-4 text-indigo-600">
                            <span class="text-sm text-gray-700">Allow multiple submissions</span>
                        </label>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" onclick="closeAssignmentModal()"
                            class="flex-1 px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                            Cancel
                        </button>
                        <button type="submit" id="assignmentSubmitBtn"
                            class="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            Create Assignment
                        </button>
                    </div>
                </form>

                <div id="assignmentMessage" class="mt-4 p-4 rounded-lg hidden"></div>
            </div>
        </div>
    </div>

    <!-- View Submissions Modal -->
    <div id="submissionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-xl max-w-6xl w-full my-8 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800" id="submissionsTitle">Submissions</h3>
                    <button onclick="closeSubmissionsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>

                <div id="submissionsList">
                    <!-- Submissions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Grade Submission Modal -->
    <div id="gradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl max-w-2xl w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Grade Submission</h3>
                    <button onclick="closeGradeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>

                <div id="submissionDetails" class="mb-6">
                    <!-- Submission details will be loaded here -->
                </div>

                <form id="gradeForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Marks Obtained * (out of <span id="maxMarks">10</span>)</label>
                        <input type="number" id="gradeMarks" required min="0"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Feedback/Comments</label>
                        <textarea id="gradeFeedback" rows="4"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            placeholder="Provide feedback to the student"></textarea>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" onclick="closeGradeModal()"
                            class="flex-1 px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                            Cancel
                        </button>
                        <button type="submit" id="gradeSubmitBtn"
                            class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            Save Grade
                        </button>
                    </div>
                </form>

                <div id="gradeMessage" class="mt-4 p-4 rounded-lg hidden"></div>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000'
            : 'https://pyq-automation-system.onrender.com';
        const urlParams = new URLSearchParams(window.location.search);
        const classId = urlParams.get('classId');
        let currentAssignmentId = null;
        let currentSubmissionId = null;
        let currentMaxMarks = 10;

        if (!classId) {
            window.location.href = 'admin_classroom.html';
        }

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if auth.js is loaded
            if (typeof Auth === 'undefined') {
                console.error('Auth module not loaded');
                window.location.href = `${API_BASE_URL}/internal/login`;
                return;
            }

            if (!Auth.isAuthenticated()) {
                window.location.href = `${API_BASE_URL}/internal/login`;
                return;
            }
            
            // Verify token is still valid
            const isValid = await Auth.verifyToken();
            if (!isValid) {
                Auth.clearAuth();
                window.location.href = `${API_BASE_URL}/internal/login`;
                return;
            }
            
            // Load assignments if authenticated
            loadAssignments();
        });

        // Load assignments
        async function loadAssignments() {
            const token = sessionStorage.getItem('admin_token');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/classes/${classId}/assignments`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                document.getElementById('loadingState').classList.add('hidden');

                if (data.success && data.assignments.length > 0) {
                    document.getElementById('assignmentsList').classList.remove('hidden');
                    displayAssignments(data.assignments);
                } else {
                    document.getElementById('emptyState').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading assignments:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
            }
        }

        // Display assignments
        function displayAssignments(assignments) {
            const container = document.getElementById('assignmentsList');
            container.innerHTML = '';

            assignments.forEach(assignment => {
                const dueDate = new Date(assignment.due_date);
                const isOverdue = dueDate < new Date();
                
                const assignmentCard = document.createElement('div');
                assignmentCard.className = 'bg-white rounded-xl shadow-md p-6';

                const statusBadge = isOverdue 
                    ? '<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">üî¥ Closed</span>'
                    : '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">üü¢ Active</span>';

                const submissionRate = assignment.submission_count > 0 
                    ? Math.round((assignment.graded_count / assignment.submission_count) * 100)
                    : 0;

                assignmentCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">üìã ${assignment.title}</h4>
                            ${statusBadge}
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-indigo-600">${assignment.max_marks}</div>
                            <div class="text-sm text-gray-500">marks</div>
                        </div>
                    </div>
                    
                    <p class="text-gray-600 mb-4">${assignment.description}</p>
                    
                    <div class="grid grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${assignment.submission_count || 0}</div>
                            <div class="text-xs text-gray-500">Submissions</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${assignment.graded_count || 0}</div>
                            <div class="text-xs text-gray-500">Graded</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-600">${(assignment.submission_count || 0) - (assignment.graded_count || 0)}</div>
                            <div class="text-xs text-gray-500">Pending</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">${submissionRate}%</div>
                            <div class="text-xs text-gray-500">Graded</div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center text-sm text-gray-500 mb-4">
                        <span>üìÖ Due: ${dueDate.toLocaleString()}</span>
                        <span>Created: ${new Date(assignment.created_at).toLocaleDateString()}</span>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="viewSubmissions('${assignment.id}', '${assignment.title}', ${assignment.max_marks})"
                            class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            üì• View Submissions (${assignment.submission_count || 0})
                        </button>
                        <button onclick="deleteAssignment('${assignment.id}')"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                `;

                container.appendChild(assignmentCard);
            });
        }

        // Create assignment modal
        function openCreateAssignmentModal() {
            document.getElementById('assignmentForm').reset();
            
            // Set default due date to 7 days from now
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 7);
            document.getElementById('assignmentDueDate').value = defaultDate.toISOString().slice(0, 16);
            
            document.getElementById('assignmentModal').classList.remove('hidden');
        }

        function closeAssignmentModal() {
            document.getElementById('assignmentModal').classList.add('hidden');
            document.getElementById('assignmentMessage').classList.add('hidden');
        }

        // Create assignment
        document.getElementById('assignmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('assignmentSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            
            const token = sessionStorage.getItem('admin_token');
            
            const assignmentData = {
                title: document.getElementById('assignmentTitle').value,
                description: document.getElementById('assignmentDescription').value,
                instructions: document.getElementById('assignmentInstructions').value,
                max_marks: parseInt(document.getElementById('assignmentMarks').value),
                due_date: new Date(document.getElementById('assignmentDueDate').value).toISOString(),
                allow_late: document.getElementById('allowLate').checked,
                allow_multiple: document.getElementById('allowMultiple').checked
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/classes/${classId}/assignments`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(assignmentData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAssignmentMessage('Assignment created successfully!', 'success');
                    setTimeout(() => {
                        closeAssignmentModal();
                        loadAssignments();
                    }, 1500);
                } else {
                    showAssignmentMessage(data.error || 'Failed to create assignment', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Assignment';
                }
            } catch (error) {
                console.error('Error creating assignment:', error);
                showAssignmentMessage('Network error. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Assignment';
            }
        });

        function showAssignmentMessage(message, type) {
            const messageDiv = document.getElementById('assignmentMessage');
            messageDiv.textContent = message;
            messageDiv.className = `mt-4 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            messageDiv.classList.remove('hidden');
        }

        // View submissions
        async function viewSubmissions(assignmentId, title, maxMarks) {
            currentAssignmentId = assignmentId;
            currentMaxMarks = maxMarks;
            
            document.getElementById('submissionsTitle').textContent = `Submissions: ${title}`;
            
            const token = sessionStorage.getItem('admin_token');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/assignments/${assignmentId}/submissions`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displaySubmissions(data.submissions, maxMarks);
                    document.getElementById('submissionsModal').classList.remove('hidden');
                } else {
                    alert('Failed to load submissions');
                }
            } catch (error) {
                console.error('Error loading submissions:', error);
                alert('Network error. Please try again.');
            }
        }

        function closeSubmissionsModal() {
            document.getElementById('submissionsModal').classList.add('hidden');
        }

        // Display submissions
        function displaySubmissions(submissions, maxMarks) {
            const container = document.getElementById('submissionsList');
            
            if (submissions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üì•</div>
                        <h4 class="text-xl font-bold text-gray-800 mb-2">No Submissions Yet</h4>
                        <p class="text-gray-600">Students haven't submitted their work yet.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="space-y-4"></div>';
            const listContainer = container.querySelector('.space-y-4');
            
            submissions.forEach(sub => {
                const submissionCard = document.createElement('div');
                submissionCard.className = 'border rounded-lg p-4 hover:bg-gray-50 transition';
                
                const statusBadge = sub.status === 'graded'
                    ? `<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">‚úì Graded: ${sub.marks}/${maxMarks}</span>`
                    : `<span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">‚è≥ Pending</span>`;
                
                submissionCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="font-bold text-gray-800 mb-1">üë§ ${sub.student_name}</h5>
                            <p class="text-sm text-gray-600 mb-2">${sub.student_email}</p>
                            <p class="text-sm text-gray-500">üìÖ Submitted: ${new Date(sub.submitted_at).toLocaleString()}</p>
                            <p class="text-sm text-gray-500">üìé File: ${sub.file_name}</p>
                            ${sub.feedback ? `<p class="text-sm text-gray-600 mt-2 bg-blue-50 p-2 rounded">üí¨ ${sub.feedback}</p>` : ''}
                        </div>
                        <div class="flex flex-col gap-2">
                            ${statusBadge}
                            <a href="${sub.file_url}" target="_blank"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm text-center">
                                ‚¨áÔ∏è Download
                            </a>
                            <button onclick="openGradeModal('${sub.id}', '${sub.student_name}', '${sub.file_url}', ${sub.marks || 0}, '${(sub.feedback || '').replace(/'/g, "\\'")}', ${maxMarks})"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">
                                ${sub.status === 'graded' ? '‚úèÔ∏è Edit Grade' : '‚úèÔ∏è Grade Now'}
                            </button>
                        </div>
                    </div>
                `;
                
                listContainer.appendChild(submissionCard);
            });
        }

        // Grade submission modal
        function openGradeModal(submissionId, studentName, fileUrl, marks, feedback, maxMarks) {
            currentSubmissionId = submissionId;
            currentMaxMarks = maxMarks;
            
            document.getElementById('submissionDetails').innerHTML = `
                <div class="bg-indigo-50 rounded-lg p-4">
                    <h4 class="font-bold text-gray-800 mb-2">üë§ ${studentName}</h4>
                    <a href="${fileUrl}" target="_blank" class="text-sm text-indigo-600 hover:text-indigo-700">
                        üìé View Submission ‚Üí
                    </a>
                </div>
            `;
            
            document.getElementById('maxMarks').textContent = maxMarks;
            document.getElementById('gradeMarks').value = marks;
            document.getElementById('gradeMarks').max = maxMarks;
            document.getElementById('gradeFeedback').value = feedback;
            
            document.getElementById('gradeModal').classList.remove('hidden');
        }

        function closeGradeModal() {
            document.getElementById('gradeModal').classList.add('hidden');
            document.getElementById('gradeMessage').classList.add('hidden');
        }

        // Submit grade
        document.getElementById('gradeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('gradeSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            const token = sessionStorage.getItem('admin_token');
            const marks = parseInt(document.getElementById('gradeMarks').value);
            const feedback = document.getElementById('gradeFeedback').value;
            
            if (marks > currentMaxMarks) {
                showGradeMessage(`Marks cannot exceed ${currentMaxMarks}`, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Grade';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/submissions/${currentSubmissionId}/grade`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ marks, feedback })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showGradeMessage('Grade saved successfully!', 'success');
                    setTimeout(() => {
                        closeGradeModal();
                        viewSubmissions(currentAssignmentId, '', currentMaxMarks);
                        loadAssignments();
                    }, 1500);
                } else {
                    showGradeMessage(data.error || 'Failed to save grade', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Grade';
                }
            } catch (error) {
                console.error('Error saving grade:', error);
                showGradeMessage('Network error. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Grade';
            }
        });

        function showGradeMessage(message, type) {
            const messageDiv = document.getElementById('gradeMessage');
            messageDiv.textContent = message;
            messageDiv.className = `mt-4 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            messageDiv.classList.remove('hidden');
        }

        // Delete assignment
        async function deleteAssignment(assignmentId) {
            if (!confirm('Are you sure you want to delete this assignment? This action cannot be undone.')) {
                return;
            }
            
            const token = sessionStorage.getItem('admin_token');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/assignments/${assignmentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Assignment deleted successfully');
                    loadAssignments();
                } else {
                    alert('Failed to delete assignment: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Network error. Please try again.');
            }
        }

        // Check admin auth and load assignments
        async function init() {
            const token = sessionStorage.getItem('admin_token');
            if (!token) {
                window.location.href = `${API_BASE_URL}/internal/login`;
                return;
            }
            
            await loadAssignments();
        }

        // Removed duplicate init() call - now handled by DOMContentLoaded listener above
    </script>
</body>
</html>
